![1765193196888](image/cursorrules/1765193196888.png)---
alwaysApply: true
description: "Instrukce pro Cursor AI - HACCP Audit Assistant"
---
**üìÖ Posledn√≠ aktualizace: 2025-01-27**

Kdyz pracujes podle techto pravidel (napr. zmeny kodu, opravy, pouzivani Flowbite/Firebase), vzdy napis na zacatek odpovedi JEDU PODLE RULES a pak pokracuj v odpovedi.

# Instrukce pro Cursor AI - HACCP Audit Assistant

## üéØ Z√ÅKLADN√ç PRAVIDLA

### V≈ædy pracuj podle dokumentace
- **Flowbite dokumentace je tv≈Øj "svat√Ω gr√°l"**: https://flowbite-react.com/
- **Firebase dokumentace**: https://firebase.google.com/docs
- Pokud nƒõco nev√≠≈°, v≈ædy nejd≈ô√≠v zkontroluj dokumentaci
- Pokud nedok√°≈æe≈° nƒõco vy≈ôe≈°it, napi≈° u≈æivateli kde to najde nebo jak na to

### ‚ö†Ô∏è AUTOMATICK√Å AKTUALIZACE DOKUMENTACE
- **Kdy≈æ se mƒõn√≠ nƒõco z√°sadn√≠ho v projektu, V≈ΩDY automaticky aktualizuj relevantn√≠ dokumenty:**
  - P≈ôid√°n√≠ nov√© technologie ‚Üí aktualizuj `.cursorrules` sekci "Technologie projektu"
  - Zmƒõna struktury projektu ‚Üí aktualizuj `.cursorrules` sekci "Struktura projektu"
  - P≈ôid√°n√≠ nov√© Firebase slu≈æby ‚Üí aktualizuj `.cursorrules` sekci "Firebase pravidla"
  - Zmƒõna UI frameworku nebo pravidel ‚Üí aktualizuj `.cursorrules`
  - P≈ôid√°n√≠ nov√©ho d≈Øle≈æit√©ho souboru ‚Üí aktualizuj `.cursorrules` sekci "D≈Øle≈æit√© soubory"
- **Nepoƒç√≠tej s t√≠m, ≈æe u≈æivatel si to aktualizuje s√°m - v≈ædy to udƒõlej automaticky!**
- **Aktualizace dokumentace je souƒç√°st√≠ zmƒõny, ne samostatn√Ω krok**
- **P≈ôi aktualizaci dokumentace V≈ΩDY aktualizuj datum na zaƒç√°tku souboru**

### Technologie projektu (aktu√°ln√≠ verze k 2025-11-19)
- **Frontend**: React 19.2.0 + TypeScript 5.8.2 + Vite 6.2.0
- **UI Framework**: Flowbite React 0.12.10 (v≈ædy pou≈æ√≠vej podle dokumentace!)
- **CSS Framework**: Tailwind CSS 3.4.18 (integrovan√Ω s Flowbite)
- **Backend**: Firebase 12.5.0 (Firestore, Storage, Functions, Authentication)
- **Build**: Vite 6.2.0
- **State Management**: React Hooks + Context API
- **PDF Rendering**: @react-pdf/renderer 4.2.0 (pro Smart Template syst√©m)
- **Drag & Drop**: @dnd-kit/core 6.1.0 (pro Smart Template editor)
- **AI**: @firebase/ai 2.5.0, @google/generative-ai 0.24.1 (Gemini API)
- **Icons**: lucide-react 0.553.0, react-icons 5.5.0

---

## üé® UI PRAVIDLA - FLOWBITE

### ‚ö†Ô∏è KRITICK√â PRAVIDLA PRO UI ZMƒöNY:

1. **V≈ΩDY pou≈æ√≠vej Flowbite komponenty** podle ofici√°ln√≠ dokumentace
   - Odkaz: https://flowbite-react.com/
   - P≈ôed ka≈ædou zmƒõnou UI zkontroluj dokumentaci Flowbite

2. **Light mode ONLY** - aplikace je v≈ædy v light mode
   - `class="light"` na `<html>` tagu
   - NIKDY nepou≈æ√≠vej `dark:` t≈ô√≠dy
   - NIKDY nepou≈æ√≠vej dark mode styling

3. **Zachov√°n√≠ p≈Øvodn√≠ch barev**
   - Pro gradienty: V≈ΩDY pou≈æ√≠vej inline styles `style={{ background: 'linear-gradient(...)' }}`
   - NIKDY nepou≈æ√≠vej Tailwind gradient t≈ô√≠dy pro barvy (`bg-gradient-to-r`, atd.)
   - Barvy z `constants/designSystem.ts` - SECTION_THEMES

4. **Wrapper komponenty**
   - Existuj√≠c√≠ wrappery v `components/ui/` zachov√°vaj√≠ API
   - Pou≈æ√≠vaj√≠ Flowbite komponenty uvnit≈ô
   - Pokud vytv√°≈ô√≠≈° novou komponentu, pou≈æij Flowbite p≈ô√≠mo, ne wrapper

5. **Icon props**
   - Flowbite vy≈æaduje ikony jako funkce: `icon={() => <Icon />}`
   - NIKDY nepou≈æ√≠vej: `icon={<Icon />}`

### ‚úÖ Co V≈ΩDY dƒõlat p≈ôi zmƒõn√°ch UI:

```tsx
// ‚úÖ SPR√ÅVNƒö - Flowbite podle dokumentace
import { Button } from 'flowbite-react';
<Button color="blue" size="md">Text</Button>

// ‚úÖ SPR√ÅVNƒö - Gradient p≈ôes inline style
<div style={{
  background: `linear-gradient(to right, ${theme.colors.primary}, ${theme.colors.darkest})`
}}>

// ‚úÖ SPR√ÅVNƒö - Icon jako funkce
<TextInput icon={() => <SearchIcon />} />
```

### ‚ùå Co NIKDY nedƒõlat:

```tsx
// ‚ùå ≈†PATNƒö - custom CSS m√≠sto Flowbite
<button className="px-4 py-2 bg-blue-500">Text</button>

// ‚ùå ≈†PATNƒö - Tailwind gradient t≈ô√≠dy
<div className="bg-gradient-to-r from-blue-500 to-purple-500">

// ‚ùå ≈†PATNƒö - dark mode
<div className="bg-white dark:bg-gray-800">

// ‚ùå ≈†PATNƒö - icon jako JSX
<TextInput icon={<SearchIcon />} />
```

### üìö Flowbite dokumentace odkazy:
- **Hlavn√≠**: https://flowbite-react.com/
- **Komponenty**: https://flowbite-react.com/docs/components/button
- **Theme**: https://flowbite-react.com/docs/customize/theme

### ‚öôÔ∏è SETTINGS SCREENS UI
Pro v≈°echny obrazovky nastaven√≠ (Settings, Admin, User Management, atd.) dodr≈æuj tato pravidla:

1. **Layout**:
   - Pou≈æij `PageHeader` pro z√°hlav√≠ str√°nky (s `onBack` pokud je to podstr√°nka)
   - Obsah zabal do `Card` a `CardBody`
   - Pou≈æij grid layout pro p≈ôehledy (nap≈ô. `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`)

2. **Komponenty**:
   - **Tlaƒç√≠tka**: Pou≈æ√≠vej `Button` z `components/ui/Button` (wrapper nad Flowbite)
   - **Ikony**: Pou≈æ√≠vej v√Ωhradnƒõ `lucide-react` (nap≈ô. `Plus`, `Trash2`, `Edit`, `Save`)
   - **P≈ôep√≠naƒçe**: Pou≈æ√≠vej `ToggleSwitch` z `flowbite-react`
   - **Badge**: Pou≈æ√≠vej `Badge` z `components/ui/Badge`

3. **Konzistence**:
   - Zachovej jednotn√Ω vzhled s ostatn√≠mi obrazovkami nastaven√≠
   - Pou≈æ√≠vej `SECTION_THEMES[AppState.SETTINGS]` pro barvy v hlaviƒçce

---

## üî• FIREBASE PRAVIDLA

### Struktura Firebase slu≈æeb:

1. **Firebase Authentication**
   - `contexts/AuthContext.tsx` - wrapper pro Firebase Auth
   - `components/LoginScreen.tsx`, `components/RegisterScreen.tsx`
   - U≈æivatel√© jsou izolov√°ni podle `uid`

2. **Firestore Database**
   - V≈°echny CRUD operace v `services/firestore/`
   - Collections: 
     - `customers` (deprecated, now part of operators/premises logic but kept for compatibility)
     - `operators` (Provozovatel√©)
     - `premises` (Pracovi≈°tƒõ)
     - `audits` (Audity)
     - `reports` (Reporty)
     - `invoices` (Faktury)
     - `suppliers` (Dodavatel√©)
     - `settings` (Glob√°ln√≠ nastaven√≠)
     - `billingSettings` (Fakturaƒçn√≠ nastaven√≠ u≈æivatele)
     - `users` (U≈æivatel√©)
     - `aiUsageLogs` (Logy AI)
     - `reportTemplates` (Smart Templates)
     - `invoiceNumberingTypes` (ƒå√≠seln√© ≈ôady faktur)
   - **Security Rules**: `firestore.rules` - user isolation + admin access
   - **Indexes**: `firestore.indexes.json` - definice index≈Ø pro slo≈æit√© dotazy
   - **ID syst√©m**: Human-readable ID form√°t `{PREFIX}{YYYYMMDD}_{COUNTER}`
     - Audity: `A20250811_0001`
     - Faktury: `I20250811_0001`
     - Utility: `utils/idGenerator.ts` - `generateHumanReadableId()`
   - **Admin role a data access**:
     - Admin u≈æivatel√© (`role === 'admin' && approved === true`) vid√≠ v≈°echna data ve v≈°ech collections
     - Bƒõ≈æn√≠ u≈æivatel√© vid√≠ pouze sv√° data (filtrov√°no podle `userId`)
     - Pattern implementace: Ka≈æd√Ω service soubor obsahuje `isCurrentUserAdmin()` funkci
     - Pokud je u≈æivatel admin ‚Üí dotaz bez `where('userId', '==', userId)` filtru
     - Pokud nen√≠ admin ‚Üí dotaz s `where('userId', '==', userId)` filtrem
     - Firestore security rules podporuj√≠ admin p≈ô√≠stup p≈ôes `isAdmin()` helper funkci
     - Collections s admin access: `operators`, `premises`, `audits`, `reports`, `customers`, `invoices`, `pricing`, `suppliers`, `nonComplianceLocations`, `aiUsageLogs`, `invoiceNumberingTypes`
     - Implementaƒçn√≠ pattern:
       ```typescript
       async function isCurrentUserAdmin(): Promise<boolean> {
         try {
           const userId = getCurrentUserId();
           const metadata = await fetchUserMetadata(userId);
           return metadata?.role === 'admin' && metadata?.approved === true;
         } catch {
           return false;
         }
       }
       
       // V fetch funkci:
       const isAdmin = await isCurrentUserAdmin();
       let q;
       if (isAdmin) {
         // Admin vid√≠ v≈°echna data
         q = query(collection(db, COLLECTION_NAME), orderBy('field', 'asc'));
       } else {
         // Bƒõ≈æn√Ω u≈æivatel vid√≠ jen sv√° data
         q = query(
           collection(db, COLLECTION_NAME),
           where('userId', '==', userId),
           orderBy('field', 'asc')
         );
       }
       ```

3. **Firebase Storage**
   - `services/storage.ts` - upload/download fotek
   - Fotky audit≈Ø: `users/{userId}/audits/{auditId}/F{YYYYMMDD}_{COUNTER}.jpg`
   - PDF reporty Legacy: `reports/{reportId}/pdf`
   - Smart Template data: `reports/{reportId}/smart/{drafts|finalVersions|pdf|templates}/`
   - **Security Rules**: `storage.rules` - max 10MB pro obr√°zky
   - **Photo filename**: Human-readable form√°t `F{YYYYMMDD}_{COUNTER}.{ext}` (counter per audit + den)
     - Utility: `utils/photoIdGenerator.ts` - `generatePhotoFilename()`

4. **Cloud Functions**
   - `functions/src/` - serverless funkce
   - `generateReport.ts` - Legacy AI generov√°n√≠ report≈Ø
   - `generateSmartReportPdf.ts` - Smart Template PDF generov√°n√≠
   - `transcribeAudio.ts`, `generatePdf.ts`, `analyzeImage.ts`
   - Node.js 20 runtime

### ‚úÖ Co V≈ΩDY dƒõlat p≈ôi pr√°ci s Firebase:

```tsx
// ‚úÖ SPR√ÅVNƒö - pou≈æij existuj√≠c√≠ service funkce
import { createAudit, updateAudit } from './services/firestore';
await createAudit(auditData);

// ‚úÖ SPR√ÅVNƒö - pou≈æij AuthContext pro u≈æivatele
import { useAuth } from './contexts/AuthContext';
const { user } = useAuth();

// ‚úÖ SPR√ÅVNƒö - error handling
try {
  await someFirebaseOperation();
} catch (error) {
  toast.error('Chyba: ' + error.message);
}
```

### ‚ùå Co NIKDY nedƒõlat:

```tsx
// ‚ùå ≈†PATNƒö - p≈ô√≠m√Ω import Firebase SDK v komponent√°ch
import { collection, addDoc } from 'firebase/firestore';
// Pou≈æ√≠vej service funkce m√≠sto toho!

// ‚ùå ≈†PATNƒö - ignorov√°n√≠ error handlingu
await createAudit(data); // Co kdy≈æ sel≈æe?
```

### üìö Firebase dokumentace:
- **Firestore**: https://firebase.google.com/docs/firestore
- **Storage**: https://firebase.google.com/docs/storage
- **Functions**: https://firebase.google.com/docs/functions
- **Auth**: https://firebase.google.com/docs/auth

---

## üìÅ STRUKTURA PROJEKTU

### Hlavn√≠ adres√°≈ôe:

```
HACCP1/
‚îú‚îÄ‚îÄ components/          # React komponenty
‚îÇ   ‚îú‚îÄ‚îÄ ui/              # Flowbite wrapper komponenty (Button, Card, Input, Modal)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Pagination.tsx       # Str√°nkov√°n√≠ tabulek
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DetailTooltip.tsx    # Detailn√≠ tooltip komponenta
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TooltipCell.tsx      # Wrapper pro td s tooltipem
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ActionIconTooltip.tsx # Tooltip pro ikony akc√≠
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ icons/           # SVG ikony
‚îÇ   ‚îú‚îÄ‚îÄ report/          # Smart Template komponenty
‚îÇ   ‚îú‚îÄ‚îÄ invoices/        # Fakturace komponenty
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InvoicesPage.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InvoiceDetailPage.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InvoiceForm.tsx
‚îÇ   ‚îî‚îÄ‚îÄ [screens].tsx    # Obrazovky aplikace
‚îÇ
‚îú‚îÄ‚îÄ utils/               # Utility funkce
‚îÇ   ‚îú‚îÄ‚îÄ idGenerator.ts   # Human-readable ID generov√°n√≠
‚îÇ   ‚îú‚îÄ‚îÄ photoIdGenerator.ts  # Human-readable photo filename generov√°n√≠
‚îÇ   ‚îî‚îÄ‚îÄ toast.ts         # Toast notifikace
‚îÇ
‚îú‚îÄ‚îÄ services/            # Business logika a API
‚îÇ   ‚îú‚îÄ‚îÄ firestore/       # Firestore CRUD operace
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reportTemplates.ts  # Smart Template ≈°ablony
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reports.ts           # Reports s smart poli
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invoices.ts          # Fakturace CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billingSettings.ts   # Fakturaƒçn√≠ nastaven√≠
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ invoiceNumberingTypes.ts # ƒå√≠seln√© ≈ôady
‚îÇ   ‚îú‚îÄ‚îÄ smartTemplate/   # Smart Template slu≈æby
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SmartTemplateEngine.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templateLoader.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reportDocumentService.ts
‚îÇ   ‚îú‚îÄ‚îÄ aiLogic.ts       # AI logika
‚îÇ   ‚îú‚îÄ‚îÄ aiContentSuggestions.ts
‚îÇ   ‚îî‚îÄ‚îÄ storage.ts       # Firebase Storage
‚îÇ
‚îú‚îÄ‚îÄ contexts/            # React Contexts
‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx  # Firebase Authentication
‚îÇ   ‚îî‚îÄ‚îÄ UnsavedChangesContext.tsx  # Tracking neulo≈æen√Ωch zmƒõn ve formul√°≈ô√≠ch
‚îÇ
‚îú‚îÄ‚îÄ hooks/               # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ useAppData.ts    # Naƒç√≠t√°n√≠ dat z Firestore
‚îÇ   ‚îî‚îÄ‚îÄ useUserRole.ts
‚îÇ
‚îú‚îÄ‚îÄ types.ts             # TypeScript typy
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ smartReport.ts   # Smart Template typy
‚îÇ   ‚îî‚îÄ‚îÄ invoice.ts       # Fakturace typy
‚îÇ
‚îú‚îÄ‚îÄ constants/designSystem.ts  # Design syst√©m (SECTION_THEMES)
‚îÇ
‚îú‚îÄ‚îÄ firebaseConfig.ts    # Firebase inicializace
‚îú‚îÄ‚îÄ firestore.rules      # Firestore security rules
‚îú‚îÄ‚îÄ firestore.indexes.json # Firestore indexes
‚îú‚îÄ‚îÄ storage.rules        # Storage security rules
‚îÇ
‚îî‚îÄ‚îÄ functions/src/       # Cloud Functions
    ‚îî‚îÄ‚îÄ generateSmartReportPdf.ts  # Smart Template PDF
```

### D≈Øle≈æit√© soubory:

- **`App.tsx`** - hlavn√≠ logika aplikace, routing, state management
- **`AppWithAuth.tsx`** - wrapper s autentifikac√≠
- **`firebaseConfig.ts`** - Firebase SDK inicializace
- **`FAKTURACE_SPEC.md`** - Specifikace modulu Fakturace
- **`components/ui/Pagination.tsx`** - reusable pagination komponenta pro tabulky
- **`components/ui/DetailTooltip.tsx`** - reusable detailn√≠ tooltip komponenta
- **`vite.config.ts`** - automatick√© verzov√°n√≠ z package.json p≈ôi buildu
- **`components/ReportView.tsx`** - zobrazen√≠ report≈Ø (z√°lo≈æky Legacy/Smart)

---

## üîß WORKFLOW PRO ZMƒöNY

### P≈ôi zmƒõnƒõ UI komponenty:

1. **Zkontroluj Flowbite dokumentaci** - https://flowbite-react.com/
2. **Pou≈æij Flowbite komponentu** podle dokumentace
3. **Zachovej p≈Øvodn√≠ barvy** p≈ôes inline styles
4. **Otestuj v light mode** - aplikace je v≈ædy svƒõtl√°
5. **Pro tooltips pou≈æij reusable komponenty** - `DetailTooltip`, `TooltipCell` a `ActionIconTooltip` z `components/ui/`

### P≈ôi pr√°ci s formul√°≈ôi:

1. **Duplicate check pattern**:
   - **Operators**: Kontrola duplicitn√≠ho IƒåO (`operator_ico`) - implementov√°no v `OperatorForm.tsx`
   - **Premises**: Kontrola kombinace `premise_name` + `premise_address` (case-insensitive) - implementov√°no v `PremiseForm.tsx`
   - Pokud je nalezena duplicita ‚Üí zobrazit modal dialog pro potvrzen√≠
   - Pattern: `setDirty(false)` na zaƒç√°tku `handleSubmit`, pak kontrola duplicity, pokud duplicita ‚Üí `setDirty(true)` a zobrazen√≠ modalu

2. **UnsavedChangesContext**:
   - Pou≈æ√≠v√° se pro tracking neulo≈æen√Ωch zmƒõn ve formul√°≈ô√≠ch
   - Import: `import { useUnsavedChanges } from '../contexts/UnsavedChangesContext';`
   - Pou≈æit√≠: `const { setDirty } = useUnsavedChanges();`
   - `setDirty(true)` p≈ôi zmƒõnƒõ hodnot ve formul√°≈ôi
   - `setDirty(false)` na zaƒç√°tku `handleSubmit` a p≈ôed `onSave` v `performSave`
   - Pokud u≈æivatel chce odej√≠t s neulo≈æen√Ωmi zmƒõnami ‚Üí zobraz√≠ se modal "M√°te neulo≈æen√© zmƒõny"
   - Komponenta: `components/ConfirmationModal.tsx`

### P≈ôi pr√°ci s Firebase:

1. **Zkontroluj existuj√≠c√≠ service funkce** v `services/firestore/`
2. **Pou≈æij existuj√≠c√≠ funkce** m√≠sto p≈ô√≠m√©ho Firebase SDK
3. **Respektuj security rules** - u≈æivatel√© jsou izolov√°ni, admini vid√≠ v≈°echna data
4. **Respektuj admin data access pattern** - p≈ôi vytv√°≈ôen√≠ nov√Ωch fetch funkc√≠ pou≈æij `isCurrentUserAdmin()` pattern
5. **P≈ôidej error handling** - v≈°echny operace mohou selhat

---

## ‚úÖ CHECKLIST P≈òED COMMITEM

### UI zmƒõny:
- [ ] Pou≈æil jsem Flowbite komponentu podle dokumentace?
- [ ] Zachoval jsem p≈Øvodn√≠ barvy p≈ôes inline styles?
- [ ] Komponenta funguje v light mode?
- [ ] Nen√≠ tam ≈æ√°dn√Ω dark mode CSS?
- [ ] **Aktualizoval jsem dokumentaci pokud byla zmƒõna z√°sadn√≠?**

### Firebase zmƒõny:
- [ ] Pou≈æil jsem existuj√≠c√≠ service funkce?
- [ ] P≈ôidal jsem error handling?
- [ ] Security rules jsou spr√°vnƒõ nastaven√©?
- [ ] Respektuji admin data access pattern p≈ôi pr√°ci s Firestore?
- [ ] **Aktualizoval jsem dokumentaci pokud byla zmƒõna z√°sadn√≠?**

### Obecn√©:
- [ ] K√≥d je TypeScript validn√≠?
- [ ] Build proch√°z√≠ (`npm run build`)?
- [ ] **Aktualizoval jsem `.cursorrules` a datum aktualizace pokud byla zmƒõna z√°sadn√≠?**

---

## üö® ƒåAST√â CHYBY

1. **Nepou≈æit√≠ Flowbite dokumentace** - V≈ΩDY zkontroluj https://flowbite-react.com/
2. **Dark mode t≈ô√≠dy** - Aplikace je v≈ædy svƒõtl√°, nepou≈æ√≠vej dark mode
3. **Tailwind gradienty m√≠sto inline styles** - Pou≈æ√≠vej inline styles pro gradienty
4. **P≈ô√≠m√Ω Firebase SDK v komponent√°ch** - Pou≈æ√≠vej service funkce z `services/firestore/`
5. **Icon jako JSX m√≠sto funkce** - Flowbite vy≈æaduje `icon={() => <Icon />}`

---

## üìö D≈ÆLE≈ΩIT√â ODKAZY

### Dokumentace:
- **Flowbite React**: https://flowbite-react.com/
- **Firebase**: https://firebase.google.com/docs

---

## ‚ö†Ô∏è POKUD NƒöCO NEV√ç≈†

1. **Zkontroluj dokumentaci** - Flowbite nebo Firebase
2. **Zkontroluj podobn√Ω k√≥d** v projektu - jak se to dƒõl√° jinde
3. **Pokud nedok√°≈æe≈° vy≈ôe≈°it** - napi≈° u≈æivateli konkr√©tnƒõ kde to najde nebo jak na to

---

## üìë TAB (KARTY) SYST√âM

### Z√°kladn√≠ principy

**Taby se pou≈æ√≠vaj√≠ pouze pro:**
- ‚úÖ `AUDIT_LIST` - Seznam audit≈Ø pro pracovi≈°tƒõ
- ‚úÖ `AUDIT_IN_PROGRESS` - Prob√≠haj√≠c√≠ audit (checklist)
- ‚úÖ `REPORT_VIEW` - Zobrazen√≠ reportu

**Taby se NEPOU≈Ω√çVAJ√ç pro:**
- ‚ùå Hlavn√≠ obrazovky (dashboard, seznamy) - p≈ô√≠stupn√© p≈ôes sidebar
- ‚ùå Formul√°≈ôe (ADD_*, EDIT_*) - otev√≠raj√≠ se jako overlay
- ‚ùå Nastaven√≠ a dal≈°√≠ obrazovky
- ‚ùå **Faktury** - pou≈æ√≠vaj√≠ standardn√≠ routing (`AppState.INVOICES`, `AppState.INVOICE_DETAIL`)

### Logika vytv√°≈ôen√≠ tab≈Ø

**Centr√°ln√≠ funkce:** `openOrActivateTab()` v `App.tsx`

```typescript
openOrActivateTab(
  auditId: string | undefined,
  tabType: 'audit' | 'report' | 'audit_list',
  premiseId: string,
  operatorName: string,
  premiseName?: string,
  auditDate?: string,
  status?: string
): string
```

**Chov√°n√≠:**
1. Pokud existuje tab pro stejn√Ω audit/premise ‚Üí aktivuje se existuj√≠c√≠ tab
2. Pokud existuje tab s jin√Ωm typem ‚Üí aktualizuje se typ tabu
3. Pokud tab neexistuje ‚Üí vytvo≈ô√≠ se nov√Ω tab

### Form√°t n√°zv≈Ø tab≈Ø

- **audit_list**: "Audity ([N√°zev pracovi≈°tƒõ])"
- **audit**: "Audit ([N√°zev provozovatele])"
- **report**: "Report ([N√°zev provozovatele])"

### Tooltips

Ka≈æd√Ω tab m√° `title` atribut s detaily:
- **audit_list**: "Seznam audit≈Ø - [Provozovatel] ([Pracovi≈°tƒõ])"
- **audit**: "Audit - [Provozovatel] ([Pracovi≈°tƒõ]) - [Datum] - [Status]"
- **report**: "Report - [Provozovatel] ([Pracovi≈°tƒõ]) - [Datum] - [Status]"

### "Zpƒõt" navigace

**`handleBackToAuditList()`:**
- Pokud je aktivn√≠ `audit_list` tab ‚Üí vrac√≠ na p≈ôedchoz√≠ view (OPERATOR_DASHBOARD)
- Pokud je aktivn√≠ `audit` nebo `report` tab ‚Üí vrac√≠ na AUDIT_LIST pro dan√© pracovi≈°tƒõ
- Pokud nejsou taby ‚Üí vrac√≠ na p≈ôedchoz√≠ appState

### Zobrazen√≠ TabBar

- **Desktop (xl+)**: TabBar se zobrazuje pod headerem (pouze jedenkr√°t)
- **Mobile/Tablet**: TabBar se nezobrazuje (taby nejsou podporov√°ny na mal√Ωch obrazovk√°ch)
- **Renderov√°n√≠**: `components/Layout.tsx` - pouze pokud `tabs.length > 0`

---

## üß© SMART TEMPLATE SYST√âM

### Z√°kladn√≠ principy
- **Paraleln√≠ syst√©m** - funguje vedle Legacy syst√©mu, ≈æ√°dn√© zmƒõny v Legacy k√≥du
- **Legacy syst√©m z≈Øst√°v√° beze zmƒõny** - ≈æ√°dn√© √∫pravy st√°vaj√≠c√≠ch komponent
- **UI p≈ôep√≠naƒç** - u≈æivatel si m≈Ø≈æe vybrat mezi Legacy a Smart m√≥dem v `ReportView`

### Struktura Smart Template
- **Template Rules** - JSON pravidla layoutu (ulo≈æeny v `reportTemplates` collection)
- **ReportDocument** - struktura p≈ôipraven√° pro render (WYSIWYG)
- **SmartTemplateEngine** - aplikuje pravidla ≈°ablony na audit data
- **Storage struktura**: `reports/{reportId}/smart/{drafts|finalVersions|pdf|templates}/`

### P≈ôi pr√°ci se Smart Template:
1. **V≈ædy pou≈æij existuj√≠c√≠ slu≈æby** z `services/smartTemplate/`
2. **Nepou≈æ√≠vej p≈ô√≠m√Ω Firebase SDK** - pou≈æij `reportDocumentService.ts`
3. **Respektuj strukturu Storage** - Smart data jsou v `smart/` podadres√°≈ôi
4. **Legacy syst√©m beze zmƒõny** - ≈æ√°dn√© √∫pravy `ReportView.tsx` Legacy ƒç√°sti

### D≈Øle≈æit√© soubory Smart Template:
- `services/smartTemplate/SmartTemplateEngine.ts` - engine pro aplikaci pravidel
- `components/report/SmartTemplateView.tsx` - hlavn√≠ UI komponenta
- `types/smartReport.ts` - typy pro Smart Template

---

## üßæ FAKTURACE (INVOICES)

### Z√°kladn√≠ principy
- **Samostatn√Ω modul** - spravuje vydan√© faktury
- **Vazba na audity** - fakturu lze vystavit z auditu (p≈ôenese se customer a polo≈æky)
- **Vazba na z√°kazn√≠ky** - faktura je v≈ædy v√°zan√° na z√°kazn√≠ka (Customer/Operator)

### Struktura Fakturace
- **Collection**: `invoices`
- **ID form√°t**: `I{YYYYMMDD}_{COUNTER}` (nap≈ô. `I20251119_0001`)
- **Statusy**: `draft`, `issued`, `paid`, `cancelled`
- **Specifikace**: Detailn√≠ popis v `FAKTURACE_SPEC.md`

### D≈Øle≈æit√© soubory Fakturace:
- `components/invoices/InvoicesPage.tsx` - seznam faktur
- `components/invoices/InvoiceDetailPage.tsx` - detail faktury
- `components/invoices/InvoiceForm.tsx` - formul√°≈ô
- `services/firestore/invoices.ts` - CRUD operace
- `services/firestore/billingSettings.ts` - nastaven√≠ fakturace
- `types/invoice.ts` - TypeScript definice

### Routing a Navigace
- Faktury **nepou≈æ√≠vaj√≠** Tab syst√©m
- Pou≈æ√≠vaj√≠ `AppState`: `INVOICES`, `INVOICE_DETAIL`, `INVOICE_CREATE`, `INVOICE_EDIT`
- Navigace zpƒõt vede na seznam faktur (`AppState.INVOICES`)

---

## üì± RESPONSIVITA A BREAKPOINTY

### Breakpoint strategie
- **Mobile** (<768px): Hamburger menu, mobiln√≠ karty
- **Tablet** (768-1279px): Top horizontal bar, desktop tabulky
- **Desktop Small** (1280-1919px): Sidebar s texty
- **Desktop Large** (1920px+): Full sidebar s texty

### Navigace podle za≈ô√≠zen√≠
- **Mobil**: MobileMenu overlay (hamburger)
- **Tablet**: Top horizontal bar s ikonami (skryt√Ω sidebar)
- **Desktop**: Sidebar vlevo (skryt√Ω na < 1280px)

### Str√°nkov√°n√≠ tabulek
- Defaultnƒõ 20 polo≈æek/str√°nka
- Mo≈ænost v√Ωbƒõru: 10, 20, 50, 100
- Komponenta: `components/ui/Pagination.tsx`
- Implementov√°no v: OperatorDashboard, AllAuditsScreen, AuditList, InvoicesPage

### User Avatar
- Pouze jedno m√≠sto: vpravo naho≈ôe v top baru (desktop) nebo v tablet top bar
- Form√°t: pouze inici√°la v kruhu, bez ikony

### Responzivn√≠ tabulky
- Padding: `px-3 md:px-4 xl:px-6 py-3 md:py-4`
- Ikony: `h-4 w-4 md:h-5 md:w-5 xl:h-4 xl:w-4`
- Tlaƒç√≠tka: `p-1 md:p-2 xl:p-1`
- Horizont√°ln√≠ scroll: `min-w-[900px] xl:min-w-0` wrapper

---

## üìë TOOLTIP SYST√âM

### Reusable Tooltip Komponenty

**DetailTooltip** (`components/ui/DetailTooltip.tsx`):
- Komponenta pro zobrazen√≠ detailn√≠ch informac√≠ p≈ôi hoveru
- Automaticky ≈ôe≈°√≠ pozicov√°n√≠ (top/bottom) a z-index
- Pou≈æ√≠v√° se pro provozovatele, pracovi≈°tƒõ a dal≈°√≠ komplexn√≠ tooltips

**TooltipCell** (`components/ui/TooltipCell.tsx`):
- Wrapper pro `<td>` element s tooltipem
- Automaticky p≈ôid√°v√° `overflow-hidden` a `has-[.group:hover]:overflow-visible`
- Zaji≈°≈•uje spr√°vn√© zobrazen√≠ tooltipu mimo ≈ô√°dek

**ActionIconTooltip** (`components/ui/ActionIconTooltip.tsx`):
- Komponenta pro zobrazen√≠ tooltipu u ikon akc√≠ v tabulk√°ch
- Automaticky ≈ôe≈°√≠ pozicov√°n√≠ (pod ikonou, nebo nad pokud je posledn√≠ ≈ô√°dek)
- Zaji≈°≈•uje okam≈æit√© zobrazen√≠ bez zpo≈ædƒõn√≠
- Pou≈æ√≠v√° se pro v≈°echny ikony akc√≠ (Edit, Delete, Add, atd.)

**Pou≈æit√≠:**
```tsx
import { DetailTooltip } from './ui/DetailTooltip';
import { TooltipCell } from './ui/TooltipCell';
import { ActionIconTooltip } from './ui/ActionIconTooltip';

<TooltipCell className="px-3 md:px-2 xl:px-6 py-3 md:py-2 xl:py-4">
  <DetailTooltip
    position={isLastRow ? 'top' : 'bottom'}
    content={
      <div className="space-y-1.5">
        <div className="font-bold text-sm mb-2 pb-2 border-b border-gray-700">
          {operator.operator_name}
        </div>
        {/* dal≈°√≠ obsah */}
      </div>
    }
  >
    <span className="cursor-help truncate block w-full">
      {operator.operator_name}
    </span>
  </DetailTooltip>
</TooltipCell>

<div className="relative group/button">
  <button className="...">
    <Icon />
  </button>
  <ActionIconTooltip text="Upravit" isLastRow={isLastRow} />
</div>
```

**Pravidla:**
- V≈ΩDY pou≈æ√≠vej `DetailTooltip` a `TooltipCell` pro detailn√≠ tooltips
- V≈ΩDY pou≈æ√≠vej `ActionIconTooltip` pro tooltips u ikon akc√≠
- Tooltip se zobrazuje pouze p≈ôi hoveru na konkr√©tn√≠ hodnotu/ikonu, ne na cel√Ω ≈ô√°dek
- Pro posledn√≠ ≈ô√°dek tabulky pou≈æij `isLastRow={true}` pro `DetailTooltip` a `ActionIconTooltip`, jinak `isLastRow={false}` nebo vynechej (default je `false`)
- Tooltip obsahuje tmav√© pozad√≠ (`bg-gray-900`) a b√≠l√Ω text
- Minim√°ln√≠ ≈°√≠≈ôka pro `DetailTooltip`: `250px`, maxim√°ln√≠: `350px` (lze zmƒõnit p≈ôes props)
- `ActionIconTooltip` se zobrazuje okam≈æitƒõ, bez zpo≈ædƒõn√≠ (`transition-opacity` je odstranƒõn)
- NIKDY nepou≈æ√≠vej `title` atributy na tlaƒç√≠tk√°ch s ikonami - zp≈Øsobuj√≠ duplicitn√≠ tooltips

---

## üöÄ DEPLOY A NASTAVEN√ç

### Lok√°ln√≠ v√Ωvoj:
```bash
npm run dev          # Spustit dev server (http://localhost:3000)
npm run build        # Build pro produkci
npm run preview      # Preview buildu
```

### Firebase deploy:
```bash
firebase deploy                          # Deploy v≈°e
firebase deploy --only hosting          # Pouze frontend
firebase deploy --only functions        # Pouze Cloud Functions
firebase deploy --only firestore:rules  # Pouze Firestore rules
firebase deploy --only storage          # Pouze Storage rules
```

### Firebase Emul√°tory:
```bash
npm run emulators              # V≈°echny emul√°tory
npm run emulators:functions    # Pouze Functions
npm run emulators:all          # Functions, Firestore, Auth, Storage
```

### API kl√≠ƒçe a Secrets:
- **Frontend**: `.env` soubor s `VITE_FIREBASE_*` promƒõnn√Ωmi
- **Cloud Functions**: `functions/.env` s `GEMINI_API_KEY`
- **Produkce**: Firebase Secrets (`firebase functions:secrets:set GEMINI_API_KEY`)
- **Synchronizace**: `.\synchronizuj-klice.ps1` (Windows PowerShell)

### Live aplikace:
- **URL**: https://haccp-2776d.web.app
- Pou≈æij pro ovƒõ≈ôen√≠ zmƒõn v produkci

---

**PAMATUJ SI: Dokumentace je tv≈Øj nejlep≈°√≠ p≈ô√≠tel - v≈ædy ji kontroluj p≈ôed psan√≠m k√≥du!**
